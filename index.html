<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root{--wa-dark-bg:#111B21;--wa-dark-header-bg:#202C33;--wa-dark-text-primary:#E9EDEF;--wa-dark-text-secondary:#8696A0;--wa-green-accent:#00A884;--wa-dark-input-bg:#2a3942;--wa-chat-bg:#0b141a;--wa-outgoing-bubble-bg:#005c4b;--wa-dark-selection:#2a3942;--font-family:'Roboto',sans-serif;}
        html,body{height:100%;margin:0;padding:0;user-select:none;-webkit-user-select:none;}
        body{font-family:var(--font-family);background-color:var(--wa-chat-bg);display:flex;justify-content:center;align-items:center;height:100vh;}
        .whatsapp-container{width:100%;max-width:450px;height:100%;max-height:90vh;background-image:url('https://i.redd.it/qwd83gr4b2561.png');background-size:cover;display:flex;flex-direction:column;box-shadow:0 5px 25px rgba(0,0,0,0.5);border-radius:8px;overflow:hidden;position:relative;}
        .header-container{position:relative;flex-shrink:0;z-index:10;}
        .header{background-color:var(--wa-dark-header-bg);color:var(--wa-dark-text-primary);padding:10px 15px;display:flex;align-items:center;gap:15px;box-shadow:0 2px 5px rgba(0,0,0,0.3);transition:opacity 0.2s;}
        .header.hidden{display:none;}
        #header-contextual-message{position:absolute;top:0;left:0;width:100%;box-sizing:border-box;}
        .header-icon{font-size:1.2rem;cursor:pointer;color:var(--wa-dark-text-primary);}
        .chat-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;background-color:#667781;display:flex;justify-content:center;align-items:center;font-size:1.3rem;}
        .chat-info{flex-grow:1;overflow:hidden;}
        .chat-info h2{margin:0;font-size:1.1rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .chat-info p{margin:0;font-size:0.8rem;color:var(--wa-dark-text-secondary);}
        .chat-area{flex-grow:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;}
        .chat-footer{display:flex;flex-direction:column;background-color:var(--wa-dark-bg);}
        .editing-indicator{width:100%;background-color:var(--wa-dark-input-bg);padding:8px 15px;box-sizing:border-box;display:flex;justify-content:space-between;align-items:center;color:var(--wa-dark-text-secondary);font-size:0.9rem;}
        .editing-indicator.hidden{display:none;}
        .editing-indicator i{cursor:pointer;}
        .footer-main{display:flex;align-items:center;padding:10px;gap:10px;}
        #file-input{display:none;}
        .footer-icon{color:var(--wa-dark-text-secondary);font-size:1.3rem;cursor:pointer;padding:8px;}
        .message-input{flex-grow:1;background-color:var(--wa-dark-input-bg);border:none;border-radius:20px;padding:12px 15px;color:var(--wa-dark-text-primary);font-size:1rem;outline:none;}
        .send-btn{width:45px;height:45px;border-radius:50%;background-color:var(--wa-green-accent);border:none;color:white;font-size:1.2rem;cursor:pointer;display:flex;justify-content:center;align-items:center;flex-shrink:0;}
        .message-bubble{max-width:75%;padding:8px 12px;border-radius:8px;word-wrap:break-word;display:flex;flex-direction:column;box-shadow:0 1px 1px rgba(0,0,0,0.1);position:relative;transition:background-color 0.2s;}
        .message-bubble.outgoing{background-color:var(--wa-outgoing-bubble-bg);align-self:flex-end;color:var(--wa-dark-text-primary);}
        .message-bubble.selected{background-color:var(--wa-dark-selection);}
        .message-text{margin-bottom:4px;}
        .message-time-wrapper{display:flex;align-items:center;gap:5px;align-self:flex-end;}
        .edited-label{font-size:0.7rem;color:#a1c3b3;opacity:0.8;}
        .message-time{font-size:0.7rem;color:#a1c3b3;}
        .media-bubble{padding:5px;}
        .media-bubble img,.media-bubble video{max-width:100%;border-radius:5px;cursor:pointer;}
        .media-bubble audio{width:100%;}
        .file-bubble a{text-decoration:none;color:inherit;display:flex;align-items:center;gap:10px;}
        .modal-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:1000;opacity:1;transition:opacity 0.2s ease-in-out;}
        .modal-overlay.hidden{opacity:0;pointer-events:none;}
        .modal-content{background-color:var(--wa-dark-header-bg);padding:24px;border-radius:4px;width:80%;max-width:320px;}
        .modal-content h2{margin:0 0 16px 0;font-size:1.2rem;color:var(--wa-dark-text-primary);font-weight:500;}
        .modal-actions{display:flex;justify-content:flex-end;gap:20px;margin-top:24px;}
        .modal-actions button{background:none;border:none;color:var(--wa-green-accent);font-weight:700;font-size:0.9rem;cursor:pointer;padding:8px;text-transform:uppercase;}
        #image-viewer-modal{background-color:rgba(0,0,0,0.85);position:fixed;}
        #modal-image{max-width:90%;max-height:90%;object-fit:contain;}
        #close-modal-btn{position:absolute;top:20px;right:30px;font-size:2.5rem;color:white;cursor:pointer;}
        .dropdown-menu{position:absolute;top:60px;right:10px;background-color:var(--wa-dark-header-bg);border-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,0.5);z-index:20;overflow:hidden;transition:transform 0.2s, opacity 0.2s;transform-origin:top right;transform:scale(0);opacity:0;}
        .dropdown-menu.visible{transform:scale(1);opacity:1;}
        .dropdown-item{padding:12px 20px;color:var(--wa-dark-text-primary);cursor:pointer;}
        .dropdown-item:hover{background-color:var(--wa-dark-selection);}
    </style>
</head>
<body>
    <div class="whatsapp-container">
        <div class="header-container">
            <div id="header-default" class="header">
                <i id="back-arrow" class="fas fa-arrow-left header-icon"></i>
                <div id="chat-header-avatar" class="chat-avatar"><i class="fas fa-users"></i></div>
                <img id="chat-header-photo" src="" alt="" class="chat-avatar" style="display: none;">
                <div class="chat-info"><h2 id="chat-header-name">Carregando...</h2><p>Membros do grupo</p></div>
                <i class="fas fa-video header-icon"></i><i class="fas fa-phone header-icon"></i><i id="more-options-btn" class="fas fa-ellipsis-v header-icon"></i>
            </div>
            <div id="header-contextual-message" class="header hidden">
                <i id="contextual-back-arrow-msg" class="fas fa-arrow-left header-icon"></i>
                <div class="chat-info"></div>
                <i id="edit-message-icon" class="fas fa-pencil header-icon"></i>
                <i id="delete-message-icon" class="fas fa-trash header-icon"></i>
            </div>
            <div id="more-options-menu" class="dropdown-menu"><div id="clear-chat-btn" class="dropdown-item">Limpar conversa</div></div>
        </div>
        <div id="chat-area" class="chat-area"></div>
        <div class="chat-footer">
            <div id="editing-indicator" class="editing-indicator hidden"><span>Editando mensagem</span><i id="cancel-edit-btn" class="fas fa-times"></i></div>
            <div class="footer-main">
                <input id="file-input" type="file"><i id="attach-file-btn" class="fas fa-paperclip footer-icon"></i>
                <input id="message-input" type="text" class="message-input" placeholder="Mensagem">
                <button id="send-btn" class="send-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    <div id="image-viewer-modal" class="modal-overlay hidden"><span id="close-modal-btn">&times;</span><img id="modal-image" src=""></div>
    <div id="delete-message-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Apagar mensagem?</h2><div class="modal-actions"><button id="cancel-delete-msg-btn">Cancelar</button><button id="confirm-delete-msg-btn">Apagar</button></div></div></div>
    <div id="clear-chat-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Limpar esta conversa?</h2><p style="color:var(--wa-dark-text-secondary);font-size:0.9rem;">As mensagens ser√£o removidas permanentemente.</p><div class="modal-actions"><button id="cancel-clear-chat-btn">Cancelar</button><button id="confirm-clear-chat-btn">Limpar</button></div></div></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, push, onValue, serverTimestamp, query, orderByChild, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig={apiKey:"AIzaSyDit6JdJfEescgLC1TP6WKdXSt41j492m0",authDomain:"mensagem4-46441.firebaseapp.com",databaseURL:"https://mensagem4-46441-default-rtdb.firebaseio.com",projectId:"mensagem4-46441",storageBucket:"mensagem4-46441.appspot.com",messagingSenderId:"14919682122",appId:"1:14919682122:web:94cad28d680d1a7d033eb3",measurementId:"G-RB6H9B31BV"};
        const app=initializeApp(firebaseConfig);
        const database=getDatabase(app);
        const el={backArrow:document.getElementById('back-arrow'),groupName:document.getElementById('chat-header-name'),groupAvatar:document.getElementById('chat-header-avatar'),groupPhoto:document.getElementById('chat-header-photo'),chatArea:document.getElementById('chat-area'),messageInput:document.getElementById('message-input'),sendBtn:document.getElementById('send-btn'),attachFileBtn:document.getElementById('attach-file-btn'),fileInput:document.getElementById('file-input'),imageViewerModal:document.getElementById('image-viewer-modal'),modalImage:document.getElementById('modal-image'),closeModalBtn:document.getElementById('close-modal-btn'),headerDefault:document.getElementById('header-default'),headerContextual:document.getElementById('header-contextual-message'),contextualBackArrowMsg:document.getElementById('contextual-back-arrow-msg'),deleteMessageIcon:document.getElementById('delete-message-icon'),editMessageIcon:document.getElementById('edit-message-icon'),deleteMessageModal:document.getElementById('delete-message-modal'),cancelDeleteMsgBtn:document.getElementById('cancel-delete-msg-btn'),confirmDeleteMsgBtn:document.getElementById('confirm-delete-msg-btn'),editingIndicator:document.getElementById('editing-indicator'),cancelEditBtn:document.getElementById('cancel-edit-btn'),moreOptionsBtn:document.getElementById('more-options-btn'),moreOptionsMenu:document.getElementById('more-options-menu'),clearChatBtn:document.getElementById('clear-chat-btn'),clearChatModal:document.getElementById('clear-chat-modal'),cancelClearChatBtn:document.getElementById('cancel-clear-chat-btn'),confirmClearChatBtn:document.getElementById('confirm-clear-chat-btn'),};
        let selectedMessage={key:null,element:null,type:null};
        let editState={isEditing:false,key:null};
        let longPressActive=false;
        const urlParams=new URLSearchParams(window.location.search);
        const groupId=urlParams.get('id');
        if(!groupId)window.location.href='index.html';
        const groupRef=ref(database,'groups/'+groupId);
        get(groupRef).then((snapshot)=>{if(snapshot.exists()){const groupData=snapshot.val();el.groupName.textContent=groupData.name;if(groupData.photoURL){el.groupPhoto.src=groupData.photoURL;el.groupPhoto.style.display='flex';el.groupAvatar.style.display='none';}listenForMessages();}else{window.location.href='index.html';}});
        const handleSendMessage=()=>{const text=el.messageInput.value.trim();if(text==='')return;if(editState.isEditing){const messageRef=ref(database,`groups/${groupId}/messages/${editState.key}`);update(messageRef,{text:text,edited:true});exitEditMode();}else{const messagesRef=ref(database,`groups/${groupId}/messages`);push(messagesRef,{type:'text',text:text,createdAt:serverTimestamp()});}el.messageInput.value='';el.messageInput.focus();};
        const handleFileUpload=(e)=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=(loadEvent)=>{let type='file';if(file.type.startsWith('image/'))type='image';else if(file.type.startsWith('audio/'))type='audio';else if(file.type.startsWith('video/'))type='video';const fileMessage={type:type,fileName:file.name,fileSize:file.size,fileData:loadEvent.target.result,createdAt:serverTimestamp()};push(ref(database,`groups/${groupId}/messages`),fileMessage);};reader.readAsDataURL(file);el.fileInput.value='';};
        const formatTimestamp=(ts)=>ts?new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'';
        const createMessageBubble=(message,key)=>{const bubble=document.createElement('div');bubble.dataset.key=key;bubble.dataset.type=message.type;bubble.classList.add('message-bubble','outgoing');let content='';switch(message.type){case'image':bubble.classList.add('media-bubble');content=`<img src="${message.fileData}" alt="${message.fileName}"><span class="message-time">${formatTimestamp(message.createdAt)}</span>`;break;case'audio':bubble.classList.add('media-bubble');content=`<audio controls src="${message.fileData}"></audio><span class="message-time">${formatTimestamp(message.createdAt)}</span>`;break;case'video':bubble.classList.add('media-bubble');content=`<video controls src="${message.fileData}"></video><span class="message-time">${formatTimestamp(message.createdAt)}</span>`;break;case'file':bubble.classList.add('file-bubble');content=`<a href="${message.fileData}" download="${message.fileName}"><i class="fa-solid fa-file"></i></a><span class="message-time">${formatTimestamp(message.createdAt)}</span>`;break;default:const editedLabel=message.edited?`<span class="edited-label">(editado)</span>`:'';content=`<span class="message-text">${message.text}</span><div class="message-time-wrapper">${editedLabel}<span class="message-time">${formatTimestamp(message.createdAt)}</span></div>`;}bubble.innerHTML=content;return bubble;};
        const listenForMessages=()=>{const messagesQuery=query(ref(database,`groups/${groupId}/messages`),orderByChild('createdAt'));onValue(messagesQuery,(snapshot)=>{el.chatArea.innerHTML='';if(snapshot.exists()){snapshot.forEach((childSnapshot)=>{el.chatArea.appendChild(createMessageBubble(childSnapshot.val(),childSnapshot.key));});el.chatArea.scrollTop=el.chatArea.scrollHeight;}});};
        const selectMessage=(element)=>{if(selectedMessage.element)selectedMessage.element.classList.remove('selected');selectedMessage.key=element.dataset.key;selectedMessage.element=element;selectedMessage.type=element.dataset.type;element.classList.add('selected');el.headerDefault.classList.add('hidden');el.headerContextual.classList.remove('hidden');el.editMessageIcon.style.display=selectedMessage.type==='text'?'block':'none';};
        const deselectMessage=()=>{if(selectedMessage.element)selectedMessage.element.classList.remove('selected');selectedMessage={key:null,element:null,type:null};el.headerDefault.classList.remove('hidden');el.headerContextual.classList.add('hidden');};
        const enterEditMode=()=>{const messageText=selectedMessage.element.querySelector('.message-text').textContent;editState={isEditing:true,key:selectedMessage.key};el.messageInput.value=messageText;el.messageInput.focus();el.editingIndicator.classList.remove('hidden');el.sendBtn.innerHTML='<i class="fas fa-check"></i>';deselectMessage();};
        const exitEditMode=()=>{editState={isEditing:false,key:null};el.messageInput.value='';el.editingIndicator.classList.add('hidden');el.sendBtn.innerHTML='<i class="fas fa-paper-plane"></i>';};
        const deleteSelectedMessage=()=>{if(selectedMessage.key){remove(ref(database,`groups/${groupId}/messages/${selectedMessage.key}`));deselectMessage();}el.deleteMessageModal.classList.add('hidden');};
        const clearChat=()=>{remove(ref(database,`groups/${groupId}/messages`));el.clearChatModal.classList.add('hidden');};
        const handlePress=(e)=>{const bubble=e.target.closest('.message-bubble');if(!bubble||editState.isEditing)return;longPressActive=false;let pressTimer=setTimeout(()=>{longPressActive=true;selectMessage(bubble);},500);const cancelPress=()=>{clearTimeout(pressTimer);};bubble.addEventListener('mouseup',cancelPress,{once:true});bubble.addEventListener('mouseleave',cancelPress,{once:true});bubble.addEventListener('touchmove',cancelPress,{once:true});};
        const handleClick=(e)=>{if(longPressActive){longPressActive=false;return;}if(selectedMessage.key){deselectMessage();return;}const bubble=e.target.closest('.message-bubble');if(e.target.tagName==='IMG'&&bubble){el.modalImage.src=e.target.src;el.imageViewerModal.classList.remove('hidden');}};
        el.backArrow.addEventListener('click',()=>window.history.back());
        el.sendBtn.addEventListener('click',handleSendMessage);
        el.messageInput.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSendMessage();}});
        el.attachFileBtn.addEventListener('click',()=>el.fileInput.click());
        el.fileInput.addEventListener('change',handleFileUpload);
        el.chatArea.addEventListener('mousedown',handlePress);
        el.chatArea.addEventListener('touchstart',handlePress,{passive:true});
        el.chatArea.addEventListener('click',handleClick);
        el.closeModalBtn.addEventListener('click',()=>el.imageViewerModal.classList.add('hidden'));
        el.imageViewerModal.addEventListener('click',(e)=>{if(e.target===el.imageViewerModal)el.imageViewerModal.classList.add('hidden');});
        el.contextualBackArrowMsg.addEventListener('click',deselectMessage);
        el.deleteMessageIcon.addEventListener('click',()=>el.deleteMessageModal.classList.remove('hidden'));
        el.cancelDeleteMsgBtn.addEventListener('click',()=>el.deleteMessageModal.classList.add('hidden'));
        el.confirmDeleteMsgBtn.addEventListener('click',deleteSelectedMessage);
        el.editMessageIcon.addEventListener('click',enterEditMode);
        el.cancelEditBtn.addEventListener('click',exitEditMode);
        el.moreOptionsBtn.addEventListener('click',(e)=>{e.stopPropagation();el.moreOptionsMenu.classList.toggle('visible');});
        document.addEventListener('click',()=>el.moreOptionsMenu.classList.remove('visible'));
        el.clearChatBtn.addEventListener('click',()=>{el.clearChatModal.classList.remove('hidden');el.moreOptionsMenu.classList.remove('visible');});
        el.cancelClearChatBtn.addEventListener('click',()=>el.clearChatModal.classList.add('hidden'));
        el.confirmClearChatBtn.addEventListener('click',clearChat);
    </script>
</body>
</html>
