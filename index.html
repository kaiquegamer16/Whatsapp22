<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root{--wa-dark-bg:#111B21;--wa-dark-header-bg:#202C33;--wa-dark-text-primary:#E9EDEF;--wa-dark-text-secondary:#8696A0;--wa-green-accent:#00A884;--wa-dark-selection:#2a3942;--font-family:'Roboto',sans-serif;}
        html,body{height:100%;margin:0;padding:0;-webkit-user-select:none;-ms-user-select:none;user-select:none;}
        body{font-family:var(--font-family);background-color:#0b141a;display:flex;justify-content:center;align-items:center;height:100vh;}
        .whatsapp-container{width:100%;max-width:450px;height:100%;max-height:90vh;background-color:var(--wa-dark-bg);display:flex;flex-direction:column;box-shadow:0 5px 25px rgba(0,0,0,0.5);border-radius:8px;overflow:hidden;position:relative;}
        .screen{display:flex;flex-direction:column;width:100%;height:100%;background-color:var(--wa-dark-bg);position:absolute;top:0;left:0;transition:transform 0.3s ease-in-out;}
        .screen.hidden{transform:translateX(100%);}
        #chat-list-screen{transform:translateX(0);}
        .header-container{position:relative;flex-shrink:0;z-index:10;}
        .header{background-color:var(--wa-dark-header-bg);color:var(--wa-dark-text-primary);padding:15px;display:flex;align-items:center;gap:20px;box-shadow:0 2px 5px rgba(0,0,0,0.3);transition:opacity 0.2s;}
        .header.hidden{display:none;}
        #header-contextual{position:absolute;top:0;left:0;width:100%;box-sizing:border-box;}
        .header-icon{font-size:1.2rem;cursor:pointer;color:var(--wa-dark-text-secondary);}
        .header-title{flex-grow:1;}
        .header-title h2{margin:0;font-size:1.2rem;font-weight:500;}
        .main-content{overflow-y:auto;flex-grow:1;}
        .fab{position:absolute;bottom:25px;right:25px;width:60px;height:60px;background-color:var(--wa-green-accent);border-radius:50%;display:flex;justify-content:center;align-items:center;color:white;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,0.4);transition:transform 0.2s,opacity 0.2s;z-index:20;}
        .fab.hidden{transform:scale(0);opacity:0;}
        .chat-list,.action-list{list-style:none;padding:0;margin:0;}
        .chat-item,.action-item{display:flex;align-items:center;padding:12px 15px;gap:20px;cursor:pointer;transition:background-color 0.2s;}
        .chat-item.selected{background-color:var(--wa-dark-selection);}
        .chat-avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;background-color:#333;flex-shrink:0;display:flex;justify-content:center;align-items:center;font-size:1.5rem;color:var(--wa-dark-text-primary);}
        .chat-details{flex-grow:1;overflow:hidden;padding-right:10px;}
        .chat-name{color:var(--wa-dark-text-primary);font-size:1.1rem;}
        .chat-last-message{color:var(--wa-dark-text-secondary);font-size:0.9rem;}
        .empty-chat-message{text-align:center;color:var(--wa-dark-text-secondary);margin-top:50px;font-size:1rem;}
        .action-icon{width:48px;height:48px;border-radius:50%;background-color:var(--wa-green-accent);color:white;display:flex;justify-content:center;align-items:center;font-size:1.2rem;}
        .action-text{color:var(--wa-dark-text-primary);font-size:1.1rem;font-weight:500;}
        .create-group-content{padding:25px;background-color:var(--wa-dark-header-bg);display:flex;align-items:center;gap:20px;}
        .group-photo-container{position:relative;cursor:pointer;}
        #photo-preview{width:70px;height:70px;border-radius:50%;background-color:#667781;object-fit:cover;}
        .camera-icon{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--wa-dark-text-primary);font-size:2rem;}
        #photo-preview.has-image + .camera-icon{display:none;}
        #photo-upload{display:none;}
        .group-name-input{flex-grow:1;background:transparent;border:none;border-bottom:2px solid var(--wa-green-accent);padding:10px 0;font-size:1.1rem;outline:none;color:var(--wa-dark-text-primary);}
        .modal-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:100;opacity:1;transition:opacity 0.2s ease-in-out;}
        .modal-overlay.hidden{opacity:0;pointer-events:none;}
        .modal-content{background-color:var(--wa-dark-header-bg);padding:24px;border-radius:4px;width:80%;max-width:320px;}
        .modal-content h2{margin:0 0 16px 0;font-size:1.2rem;color:var(--wa-dark-text-primary);font-weight:500;}
        .modal-actions{display:flex;justify-content:flex-end;gap:20px;margin-top:24px;}
        .modal-actions button{background:none;border:none;color:var(--wa-green-accent);font-weight:700;font-size:0.9rem;cursor:pointer;padding:8px;text-transform:uppercase;}
    </style>
</head>
<body>
    <div class="whatsapp-container">
        <div id="chat-list-screen" class="screen">
            <div class="header-container">
                <div id="header-default" class="header"><div class="header-title"><h2>WhatsApp</h2></div><i id="delete-icon" class="fas fa-trash header-icon" style="display:none;"></i></div>
                <div id="header-contextual" class="header hidden"><i id="contextual-back-arrow" class="fas fa-arrow-left header-icon"></i><div class="header-title"><h2>1</h2></div><i id="delete-icon-context" class="fas fa-trash header-icon"></i></div>
            </div>
            <div class="main-content"><ul id="chats-container" class="chat-list"></ul></div>
            <div id="fab-new-chat" class="fab"><i class="fas fa-plus"></i></div>
        </div>
        <div id="contact-list-screen" class="screen hidden">
            <div class="header"><i class="fas fa-arrow-left header-icon back-arrow"></i><div class="header-title"><h2>Nova conversa</h2></div></div>
            <div class="main-content"><ul class="action-list"><li id="new-group-button" class="action-item"><div class="action-icon"><i class="fas fa-users"></i></div><span class="action-text">Novo grupo</span></li><li id="new-private-chat-button" class="action-item"><div class="action-icon"><i class="fas fa-user"></i></div><span class="action-text">Novo Chat Privado</span></li></ul></div>
        </div>
        <div id="new-group-screen" class="screen hidden">
            <div class="header"><i class="fas fa-arrow-left header-icon back-arrow"></i><div class="header-title"><h2>Novo grupo</h2></div></div>
            <div class="create-group-content"><div class="group-photo-container"><input type="file" id="photo-upload" accept="image/*"><img id="photo-preview" src="" alt=""><i class="fas fa-camera camera-icon"></i></div><input type="text" id="group-name" class="group-name-input" placeholder="Nome do grupo"></div>
            <div id="create-group-fab" class="fab"><i class="fas fa-check"></i></div>
        </div>
        <div id="confirmation-modal" class="modal-overlay hidden"><div class="modal-content"><h2>Apagar este chat?</h2><div class="modal-actions"><button id="cancel-delete-btn">Cancelar</button><button id="confirm-delete-btn">Apagar</button></div></div></div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, serverTimestamp, query, remove, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig={apiKey:"AIzaSyDit6JdJfEescgLC1TP6WKdXSt41j492m0",authDomain:"mensagem4-46441.firebaseapp.com",databaseURL:"https://mensagem4-46441-default-rtdb.firebaseio.com",projectId:"mensagem4-46441",storageBucket:"mensagem4-46441.appspot.com",messagingSenderId:"14919682122",appId:"1:14919682122:web:94cad28d680d1a7d033eb3",measurementId:"G-RB6H9B31BV"};
        const app=initializeApp(firebaseConfig);
        const database=getDatabase(app);
        const el={chatsContainer:document.getElementById('chats-container'),contactListScreen:document.getElementById('contact-list-screen'),newGroupScreen:document.getElementById('new-group-screen'),chatListScreen:document.getElementById('chat-list-screen'),fabNewChat:document.getElementById('fab-new-chat'),newGroupButton:document.getElementById('new-group-button'),newPrivateChatButton:document.getElementById('new-private-chat-button'),backArrows:document.querySelectorAll('.back-arrow'),photoPreview:document.getElementById('photo-preview'),photoUploadInput:document.getElementById('photo-upload'),groupNameInput:document.getElementById('group-name'),createGroupFab:document.getElementById('create-group-fab'),headerDefault:document.getElementById('header-default'),headerContextual:document.getElementById('header-contextual'),contextualBackArrow:document.getElementById('contextual-back-arrow'),deleteIcon:document.getElementById('delete-icon-context'),confirmationModal:document.getElementById('confirmation-modal'),cancelDeleteBtn:document.getElementById('cancel-delete-btn'),confirmDeleteBtn:document.getElementById('confirm-delete-btn'),};
        let currentScreen='chatListScreen';
        let selectedChat={key:null, type:null, creatorId:null};
        let currentUserId = window.Android?.getUserId() || null;
        let currentUserNickname = window.Android?.getUserNickname() || null;
        if(currentUserId && currentUserNickname){const userRef = ref(database, 'users/' + currentUserId); set(userRef, { nickname: currentUserNickname });}
        const navigateTo=(screenName)=>{document.getElementById(currentScreen).classList.add('hidden');document.getElementById(screenName).classList.remove('hidden');currentScreen=screenName;};
        el.fabNewChat.addEventListener('click',()=>navigateTo('contactListScreen'));
        el.newGroupButton.addEventListener('click',()=>navigateTo('newGroupScreen'));
        el.newPrivateChatButton.addEventListener('click',()=>window.Android?.promptForPrivateChat());
        el.backArrows.forEach(arrow=>arrow.addEventListener('click',()=>{if(currentScreen==='newGroupScreen'||currentScreen==='contactListScreen')navigateTo('chatListScreen');}));
        document.querySelector('.group-photo-container').addEventListener('click',()=>el.photoUploadInput.click());
        el.photoUploadInput.addEventListener('change',(e)=>{const file=e.target.files[0];if(file){const reader=new FileReader();reader.onload=(e)=>{el.photoPreview.src=e.target.result;};reader.readAsDataURL(file);}});
        el.createGroupFab.addEventListener('click',()=>{const groupName=el.groupNameInput.value.trim();if(!groupName)return;push(ref(database,'groups'),{name:groupName,photoURL:el.photoPreview.src||'',createdAt:serverTimestamp(),creatorId:currentUserId,creatorNickname:currentUserNickname,lastMessageTimestamp:serverTimestamp()}).then(()=>{el.groupNameInput.value='';el.photoPreview.src='';navigateTo('chatListScreen');});});
        const deselectChat=()=>{const current=document.querySelector('.chat-item.selected');if(current)current.classList.remove('selected');selectedChat={key:null,type:null,creatorId:null};el.headerDefault.classList.remove('hidden');el.headerContextual.classList.add('hidden');el.fabNewChat.classList.remove('hidden');};
        const selectChat=(element,key,type,creatorId)=>{deselectChat();selectedChat={key:key,type:type,creatorId:creatorId};element.classList.add('selected');el.headerDefault.classList.add('hidden');el.headerContextual.classList.remove('hidden');el.fabNewChat.classList.add('hidden');if(type==='group'&&currentUserId===creatorId){el.deleteIcon.style.display='block';}else{el.deleteIcon.style.display='none';}};
        el.contextualBackArrow.addEventListener('click',deselectChat);
        el.deleteIcon.addEventListener('click',()=>el.confirmationModal.classList.remove('hidden'));
        el.cancelDeleteBtn.addEventListener('click',()=>el.confirmationModal.classList.add('hidden'));
        el.confirmDeleteBtn.addEventListener('click',()=>{if(selectedChat.key&&selectedChat.type==='group'){remove(ref(database,'groups/'+selectedChat.key));remove(ref(database,'transport/'+selectedChat.key));deselectChat();}el.confirmationModal.classList.add('hidden');});
        const renderChats=(chats)=>{el.chatsContainer.innerHTML='';if(chats.length>0){chats.sort((a,b)=>(b.lastMessageTimestamp||0)-(a.lastMessageTimestamp||0));let chatsHtml='';chats.forEach(chat=>{let photoHtml,name,lastMessage;if(chat.type==='group'){photoHtml=chat.photoURL?`<img src="${chat.photoURL}" class="chat-avatar" style="object-fit:cover;"/>`:`<div class="chat-avatar"><i class="fas fa-users"></i></div>`;name=chat.name;lastMessage=`Criado por ${chat.creatorNickname||'Admin'}`;}else{const otherMemberId=Object.keys(chat.memberInfo).find(id=>id!==currentUserId);const otherMemberNickname=chat.memberInfo[otherMemberId];photoHtml=`<div class="chat-avatar"><i class="fas fa-user"></i></div>`;name=otherMemberNickname;lastMessage='Chat Privado';}chatsHtml+=`<li class="chat-item" data-key="${chat.key}" data-type="${chat.type}" data-creator="${chat.creatorId||''}">${photoHtml}<div class="chat-details"><div class="chat-name">${name}</div><div class="chat-last-message">${lastMessage}</div></div></li>`;});el.chatsContainer.innerHTML=chatsHtml;document.querySelectorAll('.chat-item').forEach(item=>{let pressTimer;const startPress=()=>{pressTimer=window.setTimeout(()=>{selectChat(item,item.dataset.key,item.dataset.type,item.dataset.creator);},500);};const cancelPress=()=>clearTimeout(pressTimer);item.addEventListener('mousedown',startPress);item.addEventListener('mouseup',cancelPress);item.addEventListener('mouseleave',cancelPress);item.addEventListener('touchstart',startPress,{passive:true});item.addEventListener('touchend',cancelPress);item.addEventListener('touchmove',cancelPress);item.addEventListener('click',()=>{if(!selectedChat.key){const key=item.dataset.key;const type=item.dataset.type;window.Android?.openChat(key,type);}});});}else{el.chatsContainer.innerHTML='<p class="empty-chat-message">Pressione + para iniciar uma conversa</p>';}};
        function listenToAllChats(){const groupsRef=query(ref(database,'groups'));const privateChatsRef=query(ref(database,'privateChats'));let allChats={};onValue(groupsRef,(snapshot)=>{snapshot.forEach(child=>{allChats[child.key]={...child.val(),key:child.key,type:'group'};});renderChats(Object.values(allChats));});onValue(privateChatsRef,(snapshot)=>{snapshot.forEach(child=>{const chatData=child.val();if(chatData.memberInfo&&chatData.memberInfo[currentUserId]){allChats[child.key]={...chatData,key:child.key,type:'private'};}});renderChats(Object.values(allChats));});}
        window.checkUserAndOpenChat = async (otherUserId) => {
            const otherUserRef = ref(database, 'users/' + otherUserId);
            const snapshot = await get(otherUserRef);
            if(snapshot.exists()) {
                const otherUserNickname = snapshot.val().nickname;
                const ids = [currentUserId, otherUserId].sort();
                const chatId = ids[0] + "_" + ids[1];
                const chatRef = ref(database, 'privateChats/' + chatId);
                const chatData = {
                    memberInfo: {
                        [currentUserId]: currentUserNickname,
                        [otherUserId]: otherUserNickname
                    },
                    lastMessageTimestamp: serverTimestamp()
                };
                set(chatRef, chatData);
                window.Android?.openChat(chatId, 'private');
            } else {
                window.Android?.onUserNotFound();
            }
        };
        listenToAllChats();
    </script>
</body>
</html>
